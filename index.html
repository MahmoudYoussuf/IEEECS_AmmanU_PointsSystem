<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Performance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="month"] { color-scheme: dark; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .header-cell-content { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; padding: 12px 6px; gap: 10px; }
        .points-badge { font-weight: 700; font-size: 0.9rem; padding: 4px 8px; border-radius: 6px; white-space: nowrap; width: 100%; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
        .action-text { text-align: center; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.01em; color: #94a3b8; line-height: 1.25; word-wrap: break-word; flex-grow: 0; }
        .badge-indigo { background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3); }
        .badge-emerald { background: rgba(52, 211, 153, 0.15); color: #34d399; border: 1px solid rgba(52, 211, 153, 0.3); }
        .badge-blue { background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); }
        .badge-red { background: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.3); }
        .badge-slate { background: rgba(148, 163, 184, 0.15); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.3); }
        .sticky-col { position: sticky; left: 0; z-index: 40; background-color: #1e293b; }
        .sticky-col-2 { position: sticky; left: 180px; z-index: 40; background-color: #1e293b; }
        thead tr th { position: sticky; top: 0; z-index: 30; background-color: #0f172a; }
        thead tr th.sticky-col, thead tr th.sticky-col-2 { z-index: 50; background-color: #0f172a; }
        tr:hover td { background-color: #334155; transition: background-color 0.15s; }
        tr:hover .sticky-col, tr:hover .sticky-col-2 { background-color: #334155; transition: background-color 0.15s; }
        .read-only-input { opacity: 0.7; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative bg-[#0f172a]">

    <!-- LOGIN VIEW -->
    <div id="loginView" class="fixed inset-0 z-[60] flex items-center justify-center bg-[#0f172a] bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-md border border-indigo-500/30 mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-500/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Admin Access</h1>
                <p class="text-slate-400 text-sm">Enter your access code to manage the team.</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Access Code</label>
                    <input type="password" id="accessCode" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full bg-slate-800/50 border border-slate-600 focus:border-indigo-500 rounded-lg px-4 py-3 text-white outline-none transition-colors text-lg tracking-widest text-center">
                    <p id="loginError" class="text-red-400 text-xs mt-2 hidden text-center">Invalid access code. Try 'admin123'.</p>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg shadow-indigo-600/30 transition-all transform hover:scale-[1.02]">
                    Unlock Dashboard
                </button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboardView" class="hidden flex-col min-h-screen p-4 md:p-6 lg:p-8 animate-fade-in w-full max-w-[1920px] mx-auto">
        <!-- Header -->
        <header class="flex-shrink-0 flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight flex items-center gap-3">
                    <span class="bg-indigo-600 w-2 h-8 rounded-full"></span>
                    <span data-translate="app_title">Team Performance Tracker</span>
                </h1>
                <p id="pageSubtitle" data-translate="app_subtitle" class="text-slate-400 mt-1 ml-5 text-sm md:text-base">Monthly scorecard & leaderboard</p>
            </div>
            <div class="flex flex-wrap gap-3 items-center w-full xl:w-auto">
                <button id="exitRangeBtn" onclick="exitRangeMode()" class="hidden px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 border border-transparent rounded-lg transition-colors shadow-lg shadow-indigo-500/30 flex items-center gap-2"><span>&larr;</span> <span data-translate="exit_range">Exit Range View</span></button>

                <div id="standardControls" class="flex flex-wrap gap-2 md:gap-3 items-center w-full xl:w-auto">
                    <select id="langSelector" onchange="setLanguage(this.value)" class="bg-slate-800 text-slate-300 text-xs font-bold uppercase border border-slate-600 rounded-lg px-2 py-2 focus:outline-none focus:border-indigo-500 cursor-pointer hover:bg-slate-700 transition-colors"><option value="en">English</option><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option></select>
                    <div class="h-8 w-px bg-slate-700 mx-1 hidden xl:block"></div>
                    <div class="relative flex-grow xl:flex-grow-0 min-w-[150px]"><input type="month" id="monthPicker" onchange="changeMonth(this.value)" class="w-full xl:w-auto bg-slate-800 text-white border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 font-medium cursor-pointer hover:bg-slate-700 transition-colors"></div>
                    <button onclick="openMemberModal()" class="flex-grow md:flex-grow-0 px-3 py-2 text-xs md:text-sm font-medium text-white bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded-lg transition-colors flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg><span class="hidden sm:inline" data-translate="btn_manage">Manage</span> <span data-translate="btn_team">Team</span></button>
                    <button onclick="openHistoryModal()" class="flex-grow md:flex-grow-0 px-3 py-2 text-xs md:text-sm font-medium text-indigo-300 bg-indigo-500/10 hover:bg-indigo-500/20 border border-indigo-500/20 rounded-lg transition-colors flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span data-translate="btn_history">History</span></button>
                    <button onclick="resetData()" class="flex-grow md:flex-grow-0 px-3 py-2 text-xs md:text-sm font-medium text-red-400 bg-red-400/10 hover:bg-red-400/20 border border-red-400/20 rounded-lg transition-colors"><span data-translate="btn_reset">Reset</span></button>
                    <button onclick="openExportModal()" class="flex-grow md:flex-grow-0 px-3 py-2 text-xs md:text-sm font-medium text-emerald-300 bg-emerald-500/10 hover:bg-emerald-500/20 border border-emerald-500/20 rounded-lg transition-colors flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span data-translate="btn_reports">Reports</span></button>
                </div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="flex-grow grid grid-cols-1 xl:grid-cols-4 gap-6 items-start pb-8 h-full overflow-hidden">
            <!-- Left: The Tracker Table -->
            <div class="xl:col-span-3 glass-panel rounded-2xl overflow-hidden flex flex-col shadow-2xl animate-fade-in w-full h-full xl:max-h-[calc(100vh-140px)]">
                <div class="overflow-auto relative h-full">
                    <table class="w-full text-left border-collapse min-w-[1000px]">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="sticky-col p-4 w-[180px] align-bottom shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] bg-[#0f172a]"><div class="text-xs uppercase tracking-wider text-slate-400 mb-2" data-translate="th_details">Details</div><div class="font-bold text-white text-lg" data-translate="th_name">Member Name</div></th>
                                <th class="sticky-col-2 p-4 w-[100px] align-bottom text-center shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] bg-[#0f172a]"><div class="text-xs uppercase tracking-wider text-slate-400 mb-2" data-translate="th_score">Score</div><div class="font-bold text-white text-lg" data-translate="th_total">Total</div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-indigo">+15</div><div class="action-text" data-translate="act_lead">Lead Event / Project</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-indigo">+10</div><div class="action-text" data-translate="act_medium">Medium Task</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-indigo">+10</div><div class="action-text" data-translate="act_idea">New Idea (Done)</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-emerald">+5</div><div class="action-text" data-translate="act_simple">Simple Task</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-red">-5</div><div class="action-text text-red-300" data-translate="act_late">Late Submission</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-blue">+3</div><div class="action-text" data-translate="act_active">Present & Active</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-blue">+2</div><div class="action-text" data-translate="act_present">Present</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-slate">0</div><div class="action-text" data-translate="act_absent_excused">Absent (Excused)</div></div></th>
                                <th class="h-[160px] w-[100px] align-bottom hover:bg-slate-800/50 transition-colors border-r border-slate-800/50 bg-[#0f172a]"><div class="header-cell-content"><div class="points-badge badge-red">-3</div><div class="action-text text-red-300" data-translate="act_absent_no">Absent (No Excuse)</div></div></th>
                            </tr>
                        </thead>
                        <tbody id="trackerBody" class="divide-y divide-slate-700/50 text-sm"></tbody>
                    </table>
                </div>
                <div id="footerNote" data-translate="footer_note" class="bg-slate-900/50 p-3 text-xs text-center text-slate-500 border-t border-slate-700 flex-shrink-0">Changes save automatically. Double-click any cell to assign exact date.</div>
            </div>

            <!-- Right: The Chart & Summary -->
            <div class="xl:col-span-1 flex flex-col gap-6 h-full xl:max-h-[calc(100vh-140px)] overflow-y-auto custom-scrollbar pr-1">
                <div class="glass-panel rounded-2xl p-5 shadow-xl animate-fade-in flex flex-col flex-shrink-0 relative" style="animation-delay: 0.2s;">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg><span data-translate="leaderboard_title">Leaderboard</span></h3>
                    <div class="w-full"><div id="chartWrapper" class="relative w-full" style="min-height: 250px;"><canvas id="scoreChart"></canvas></div></div>
                </div>

                <div class="glass-panel rounded-2xl p-6 shadow-xl relative overflow-hidden animate-fade-in flex-shrink-0" style="animation-delay: 0.3s;">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/20 rounded-full blur-2xl"></div>
                    <div class="relative z-10">
                        <div class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-4" data-translate="top_performers">Top Performers</div>
                        <div class="flex justify-between items-center mb-3"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-yellow-500/20 text-yellow-500 flex items-center justify-center font-bold border border-yellow-500/50 shadow-lg shadow-yellow-500/20">1</div><div id="top1Name" class="font-bold text-white text-lg truncate w-32">---</div></div><div id="top1Score" class="font-bold text-yellow-400 drop-shadow-md">0 pts</div></div>
                        <div class="flex justify-between items-center mb-3"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-400/20 text-slate-300 flex items-center justify-center font-bold border border-slate-400/50">2</div><div id="top2Name" class="font-medium text-slate-200 truncate w-32">---</div></div><div id="top2Score" class="font-bold text-slate-300">0 pts</div></div>
                        <div class="flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-amber-700/20 text-amber-600 flex items-center justify-center font-bold border border-amber-700/50">3</div><div id="top3Name" class="font-medium text-slate-400 truncate w-32">---</div></div><div id="top3Score" class="font-bold text-slate-500">0 pts</div></div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-5 shadow-xl animate-fade-in flex-shrink-0" style="animation-delay: 0.4s;">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span data-translate="perf_guide_title">Performance Guide</span></h3>
                    <div id="guideContainer" class="space-y-3" dir="ltr">
                        <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3"><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-emerald-400" data-translate="guide_normal_title">ðŸŸ¢ Normal State</span><span class="text-[10px] font-bold bg-emerald-500/20 text-emerald-300 px-1.5 py-0.5 rounded">25-40 pts</span></div><p class="text-xs text-slate-400" data-translate="guide_normal_desc">Committed member, no action needed.</p></div>
                        <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3"><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-yellow-400" data-translate="guide_soft_title">ðŸŸ¡ Soft Warning</span><span class="text-[10px] font-bold bg-yellow-500/20 text-yellow-300 px-1.5 py-0.5 rounded">15-24 pts</span></div><p class="text-xs text-slate-400" data-translate="guide_soft_desc">Performance below expected. Friendly follow-up needed.</p></div>
                        <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-3"><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-orange-400" data-translate="guide_official_title">ðŸŸ  Official Warning</span><span class="text-[10px] font-bold bg-orange-500/20 text-orange-300 px-1.5 py-0.5 rounded">5-14 pts</span></div><p class="text-xs text-slate-400" data-translate="guide_official_desc">Clear negligence. Written warning & improvement plan.</p></div>
                        <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-3"><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-red-400" data-translate="guide_danger_title">ðŸ”´ Final Warning</span><span class="text-[10px] font-bold bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded">&lt; 5 pts</span></div><p class="text-xs text-slate-400" data-translate="guide_danger_desc">Almost non-existent. Final warning & 1 month to improve.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Consolidated) -->
    <!-- Member Modal -->
    <div id="memberModal" class="fixed inset-0 z-[70] bg-black/80 hidden items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-2xl shadow-2xl border border-slate-600 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0"><h3 class="text-xl font-bold text-white flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg><span data-translate="modal_manage_title">Manage Members</span></h3><button onclick="closeMemberModal()" class="text-slate-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-6 flex-shrink-0"><h4 id="modalFormTitle" class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-3" data-translate="modal_add_title">Add New Member</h4><input type="hidden" id="editMemberId" value=""><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="newMemberName" placeholder="Full Name" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"><input type="text" id="newUniId" placeholder="University ID" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"><input type="text" id="newIeeeId" placeholder="IEEE Membership ID" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"><input type="text" id="newMajor" placeholder="Major" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"><input type="text" id="newPosition" placeholder="Position (e.g. Member, Lead)" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"><div class="flex gap-2 md:col-span-1"><button id="saveMemberBtn" onclick="saveMember()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow transition-colors" data-translate="btn_add_member">Add Member</button><button id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-3 rounded shadow transition-colors" data-translate="btn_cancel">Cancel</button></div></div></div>
            <div class="flex-grow overflow-y-auto pr-2"><table class="w-full text-left text-sm"><thead class="text-xs text-slate-500 uppercase bg-slate-800 sticky top-0"><tr><th class="px-3 py-2" data-translate="th_name">Name</th><th class="px-3 py-2 hidden sm:table-cell" data-translate="th_position">Position</th><th class="px-3 py-2 hidden sm:table-cell" data-translate="th_uni_id">Uni ID</th><th class="px-3 py-2 text-right" data-translate="th_action">Action</th></tr></thead><tbody id="memberListBody" class="divide-y divide-slate-700"></tbody></table></div>
        </div>
    </div>
    <!-- Export Modal -->
    <div id="exportModal" class="fixed inset-0 z-[70] bg-black/80 hidden items-center justify-center backdrop-blur-sm p-4">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-md shadow-2xl border border-slate-600">
            <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span data-translate="range_options_title">Reports & Export</span></h3>
            <div class="mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700"><label class="block text-xs text-slate-400 uppercase font-bold tracking-wider mb-3" data-translate="lbl_current_month">Current View Export</label><button onclick="exportCSV()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold transition-colors flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span data-translate="btn_export_current">Export Current Month (CSV)</span></button></div>
            <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-700"><label class="block text-xs text-slate-400 uppercase font-bold tracking-wider mb-3" data-translate="lbl_custom_range">Custom Range Analysis</label><div class="flex gap-3 mb-4"><div class="flex-1"><label class="block text-[10px] text-slate-500 mb-1 uppercase font-bold" data-translate="lbl_start">Start</label><input type="month" id="exportStart" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:border-emerald-500 outline-none"></div><div class="flex-1"><label class="block text-[10px] text-slate-500 mb-1 uppercase font-bold" data-translate="lbl_end">End</label><input type="month" id="exportEnd" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:border-emerald-500 outline-none"></div></div><div class="flex gap-3"><button onclick="performRangeView()" class="flex-1 py-2 bg-slate-700 hover:bg-emerald-600 text-white rounded-lg text-sm font-bold transition-colors border border-slate-600 hover:border-emerald-500" data-translate="btn_view_dash">View on Dashboard</button><button onclick="performRangeExport()" class="flex-1 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold transition-colors" data-translate="btn_download_csv">Download CSV</button></div></div>
            <div class="flex justify-end mt-6"><button onclick="closeExportModal()" class="text-slate-400 hover:text-white text-sm font-medium" data-translate="btn_cancel">Close</button></div>
        </div>
    </div>
    <!-- Cell Modal -->
    <div id="cellModal" class="fixed inset-0 z-[80] bg-black/90 hidden items-center justify-center backdrop-blur-sm p-4"><div class="glass-panel p-6 rounded-2xl w-full max-w-md shadow-2xl border border-slate-600"><div class="flex justify-between items-start mb-4"><div><h3 class="text-xl font-bold text-white" id="cellModalTitle">Edit Action</h3><p class="text-slate-400 text-xs mt-1" id="cellModalSubtitle">Manage dates for this score</p></div><button onclick="closeCellModal()" class="text-slate-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="mb-4 max-h-40 overflow-y-auto bg-slate-900/50 rounded-lg border border-slate-700 p-2"><table class="w-full text-sm text-left"><thead><tr class="text-xs text-slate-500 border-b border-slate-700"><th class="pb-1 pl-2">Date</th><th class="pb-1 pl-2">Time</th><th class="pb-1">Val</th><th class="pb-1">Note</th><th class="pb-1 text-right">Action</th></tr></thead><tbody id="cellHistoryBody" class="divide-y divide-slate-800"></tbody></table><div id="noHistoryMsg" class="text-center text-xs text-slate-500 py-2 hidden">No specific dates recorded.</div></div><div class="bg-slate-800 p-3 rounded-lg border border-slate-700"><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Add New Entry</label><div class="flex flex-col gap-2"><div class="flex gap-2"><input type="date" id="cellNewDate" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm w-full outline-none focus:border-indigo-500"><input type="number" id="cellNewCount" value="1" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm w-16 text-center outline-none focus:border-indigo-500"></div><div class="flex gap-2"><input type="text" id="cellNewNote" placeholder="Optional note..." class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm w-full outline-none focus:border-indigo-500"><button onclick="addCellEntry()" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-1 text-sm font-bold transition-colors">Add</button></div></div></div></div></div>
    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 z-[75] bg-black/90 hidden items-center justify-center backdrop-blur-sm p-4"><div class="glass-panel p-6 rounded-2xl w-full max-w-4xl shadow-2xl border border-slate-600 h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-6 flex-shrink-0"><h3 class="text-xl font-bold text-white" data-translate="history_title">Full Activity Log</h3><button onclick="closeHistoryModal()" class="text-slate-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="flex-grow overflow-auto"><table class="w-full text-left text-sm"><thead class="text-xs text-slate-500 uppercase bg-slate-800 sticky top-0"><tr><th class="px-4 py-3" data-translate="th_date">Date</th><th class="px-4 py-3" data-translate="th_time">Time</th><th class="px-4 py-3" data-translate="th_member">Member</th><th class="px-4 py-3" data-translate="th_action_log">Action</th><th class="px-4 py-3">Note</th><th class="px-4 py-3 text-right" data-translate="th_points">Points</th><th class="px-4 py-3 text-right" data-translate="th_del">Del</th></tr></thead><tbody id="fullHistoryBody" class="divide-y divide-slate-700 text-slate-300"></tbody></table></div></div></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      import { getFirestore, collection, doc, getDocs, setDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyDyjkaFgZ2-0H4tHjCd364zunUZHyNYIEM",
        authDomain: "ieeecs-ammanu-pointssystem.firebaseapp.com",
        projectId: "ieeecs-ammanu-pointssystem",
        storageBucket: "ieeecs-ammanu-pointssystem.firebasestorage.app",
        messagingSenderId: "431434499972",
        appId: "1:431434499972:web:ed21f81c25a8fa92fb3fd1",
        measurementId: "G-2S3FZ291Q1"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId = 'my-team-tracker-v1';

      // --- Translations & Config ---
      const i18n = {
          en: {
                app_title: "Team Performance Tracker", app_subtitle: "Monthly scorecard & leaderboard", exit_range: "Exit Range View",
                btn_manage: "Manage", btn_team: "Team", btn_history: "History", btn_reset: "Reset", btn_reports: "Reports", btn_cancel: "Cancel", btn_add_member: "Add Member",
                lbl_current_month: "Current View Export", btn_export_current: "Export Current Month (CSV)", lbl_custom_range: "Custom Range Analysis", btn_view_dash: "View on Dashboard", btn_download_csv: "Download Range CSV",
                th_details: "Details", th_name: "Member Name", th_score: "Score", th_total: "Total", th_position: "Position", th_uni_id: "Uni ID", th_action: "Action", th_date: "Date", th_time: "Time", th_member: "Member", th_action_log: "Action", th_points: "Points", th_del: "Del",
                act_lead: "Lead Event / Project", act_medium: "Medium Task", act_idea: "New Idea (Done)", act_simple: "Simple Task", act_late: "Late Submission", act_active: "Present & Active", act_present: "Present", act_absent_excused: "Absent (Excused)", act_absent_no: "Absent (No Excuse)",
                leaderboard_title: "Leaderboard", top_performers: "Top Performers", perf_guide_title: "Performance Guide",
                guide_normal_title: "ðŸŸ¢ Normal State", guide_normal_desc: "Committed member, no action needed.",
                guide_soft_title: "ðŸŸ¡ Soft Warning", guide_soft_desc: "Performance below expected. Friendly follow-up needed.",
                guide_official_title: "ðŸŸ  Official Warning", guide_official_desc: "Clear negligence. Written warning & improvement plan.",
                guide_danger_title: "ðŸ”´ Final Warning", guide_danger_desc: "Almost non-existent. Final warning & 1 month to improve.",
                modal_manage_title: "Manage Members", modal_add_title: "Add New Member", range_options_title: "Reports & Export", history_title: "Full Activity Log",
                lbl_start: "Start", lbl_end: "End", footer_note: "Changes save automatically. Double-click any cell to assign exact date."
          },
          ar: {
                app_title: "Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚", app_subtitle: "Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†", exit_range: "Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶",
                btn_manage: "Ø¥Ø¯Ø§Ø±Ø©", btn_team: "Ø§Ù„ÙØ±ÙŠÙ‚", btn_history: "Ø§Ù„Ø³Ø¬Ù„", btn_reset: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†", btn_reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", btn_cancel: "Ø¥Ù„ØºØ§Ø¡", btn_add_member: "Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ",
                lbl_current_month: "ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ", btn_export_current: "ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (CSV)", lbl_custom_range: "ØªØ­Ù„ÙŠÙ„ ÙØªØ±Ø© Ù…Ø®ØµØµØ©", btn_view_dash: "Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©", btn_download_csv: "ØªØµØ¯ÙŠØ± Ø§Ù„ÙØªØ±Ø© (CSV)",
                th_details: "Ø§Ù„ØªÙØ§ØµÙŠÙ„", th_name: "Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ", th_score: "Ø§Ù„Ù†Ù‚Ø§Ø·", th_total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹", th_position: "Ø§Ù„Ù…Ù†ØµØ¨", th_uni_id: "Ø±Ù‚Ù… Ø¬Ø§Ù…Ø¹ÙŠ", th_action: "Ø¥Ø¬Ø±Ø§Ø¡", th_date: "Ø§Ù„ØªØ§Ø±ÙŠØ®", th_time: "Ø§Ù„ÙˆÙ‚Øª", th_member: "Ø§Ù„Ø¹Ø¶Ùˆ", th_action_log: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", th_points: "Ø§Ù„Ù†Ù‚Ø§Ø·", th_del: "Ø­Ø°Ù",
                act_lead: "Ù‚ÙŠØ§Ø¯Ø© Ø­Ø¯Ø« / Ù…Ø´Ø±ÙˆØ¹", act_medium: "Ù…Ù‡Ù…Ø© Ù…ØªÙˆØ³Ø·Ø©", act_idea: "ÙÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© (ØªÙ…Øª)", act_simple: "Ù…Ù‡Ù…Ø© Ø¨Ø³ÙŠØ·Ø©", act_late: "ØªØ³Ù„ÙŠÙ… Ù…ØªØ£Ø®Ø±", act_active: "Ø­Ø¶ÙˆØ± ÙˆØªÙØ§Ø¹Ù„", act_present: "Ø­Ø¶ÙˆØ± ÙÙ‚Ø·", act_absent_excused: "ØºÙŠØ§Ø¨ (Ø¨Ø¹Ø°Ø±)", act_absent_no: "ØºÙŠØ§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±)",
                leaderboard_title: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†", top_performers: "Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø¯Ø§Ø¡", perf_guide_title: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡",
                guide_normal_title: "ðŸŸ¢ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (ØªÙ…Ø§Ù…)", guide_normal_desc: "Ø¹Ø¶Ùˆ Ù…Ù„ØªØ²Ù…ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡.",
                guide_soft_title: "ðŸŸ¡ ØªÙ†Ø¨ÙŠÙ‡ Ø®ÙÙŠÙ", guide_soft_desc: "Ø£Ø¯Ø§Ø¡ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹. Ù…Ø­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ¯ÙŠØ©.",
                guide_official_title: "ðŸŸ  Ø¥Ù†Ø°Ø§Ø± Ø±Ø³Ù…ÙŠ", guide_official_desc: "ØªÙ‚ØµÙŠØ± ÙˆØ§Ø¶Ø­. Ø¥Ù†Ø°Ø§Ø± Ù…ÙƒØªÙˆØ¨ ÙˆØ®Ø·Ø© ØªØ­Ø³ÙŠÙ†.",
                guide_danger_title: "ðŸ”´ Ø¥Ù†Ø°Ø§Ø± Ø£Ø®ÙŠØ± / Ø®Ø·Ø±", guide_danger_desc: "Ø§Ù„Ø¹Ø¶Ùˆ Ø´Ø¨Ù‡ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯. Ø¥Ù†Ø°Ø§Ø± Ø£Ø®ÙŠØ± ÙˆÙ…Ù‡Ù„Ø© Ø´Ù‡Ø±.",
                modal_manage_title: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡", modal_add_title: "Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯", range_options_title: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØµØ¯ÙŠØ±", history_title: "Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙƒØ§Ù…Ù„",
                lbl_start: "Ù…Ù† Ø´Ù‡Ø±", lbl_end: "Ø¥Ù„Ù‰ Ø´Ù‡Ø±", footer_note: "ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù†Ù‚Ø± Ù†Ù‚Ø±Ø§Ù‹ Ù…Ø²Ø¯ÙˆØ¬Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ù…Ø¹ÙŠÙ†."
          }
      };

      const pointsMap = [15, 10, 10, 5, -5, 3, 2, 0, -3];
      const actionNames = ["Lead Event", "Medium Task", "New Idea", "Simple Task", "Late Submission", "Present Active", "Present", "Absent Excused", "Absent No Excuse"];
      
      let teamData = [];
      let currentMonth = new Date().toISOString().slice(0, 7);
      let isRangeMode = false;
      let currentLang = 'en';
      let activeMemberId = null;
      let activeActionIndex = null;
      let myChart = null;
      let membersDB = []; // In-memory roster

      // --- Functions (Attached to Window for HTML access) ---
      window.handleLogin = function(e) {
        e.preventDefault();
        const code = document.getElementById('accessCode').value;
        if (code === "admin123") {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('dashboardView').classList.add('flex');
            init();
        } else {
            document.getElementById('loginError').classList.remove('hidden');
        }
      };

      window.setLanguage = function(lang) {
        currentLang = lang;
        const t = i18n[lang];
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (t[key]) el.innerText = t[key];
        });
        const guideContainer = document.getElementById('guideContainer');
        if(lang === 'ar') guideContainer.setAttribute('dir', 'rtl'); else guideContainer.setAttribute('dir', 'ltr');
      };

      window.changeMonth = function(newMonth) {
        if(isRangeMode) exitRangeMode();
        currentMonth = newMonth;
        loadData();
      };

      // --- Firebase Data Loading ---
      async function init() {
          await signInAnonymously(auth);
          // Load Roster first
          const rosterSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'roster'));
          if (!rosterSnapshot.empty) {
              const docData = rosterSnapshot.docs[0].data();
              if (docData.members) membersDB = docData.members;
          } else {
               // Seed if empty
               membersDB = [
                    { id: '1', name: 'Member 1', uniId: '', ieeeId: '', major: '', position: 'Member' },
                    { id: '2', name: 'Member 2', uniId: '', ieeeId: '', major: '', position: 'Member' }
               ];
               saveRoster();
          }

          // Initial Load
          const picker = document.getElementById('monthPicker');
          if (!picker.value) picker.value = currentMonth; else currentMonth = picker.value;
          setLanguage('en');
          
          // Setup Realtime Listener for Scores
          onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), (snapshot) => {
              if (isRangeMode) return; // Don't update if viewing range
              
              const monthDataMap = {};
              snapshot.forEach(doc => {
                  if (doc.id.startsWith(currentMonth)) {
                      const memberId = doc.id.split('_')[1];
                      monthDataMap[memberId] = doc.data();
                  }
              });

              // Merge Roster with Scores
              teamData = membersDB.map(m => {
                  const scoreData = monthDataMap[m.id];
                  // Calculate actions from history if available
                  let actions = Array(pointsMap.length).fill(0);
                  let history = scoreData ? (scoreData.history || []) : [];
                  
                  if (history.length > 0) {
                      history.forEach(log => {
                          if (actions[log.actionIdx] !== undefined) actions[log.actionIdx] += log.count;
                      });
                  }
                  
                  return { ...m, actions: actions, history: history };
              });
              
              renderTable();
              updateCalculations();
              initChart();
              updateChart();
          });
      }
      
      async function loadData() {
          const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
          const monthDataMap = {};
          snapshot.forEach(doc => {
              if (doc.id.startsWith(currentMonth)) {
                  const memberId = doc.id.split('_')[1];
                  monthDataMap[memberId] = doc.data();
              }
          });
          teamData = membersDB.map(m => {
              const scoreData = monthDataMap[m.id];
              let actions = Array(pointsMap.length).fill(0);
              let history = scoreData ? (scoreData.history || []) : [];
              if (history.length > 0) {
                  history.forEach(log => {
                      if (actions[log.actionIdx] !== undefined) actions[log.actionIdx] += log.count;
                  });
              }
              return { ...m, actions: actions, history: history };
          });
          renderTable();
          updateCalculations();
          updateChart();
      }

      async function saveRoster() {
          await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', 'main'), { members: membersDB });
      }

      async function saveMemberScore(member) {
          const docId = `${currentMonth}_${member.id}`;
          await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scores', docId), {
              history: member.history
          }, { merge: true });
      }

      // --- Actions ---
      window.updateAction = function(memberIndex, actionIndex, newValue) {
          if(isRangeMode) return;
          const member = teamData[memberIndex];
          const oldVal = member.actions[actionIndex];
          const newVal = parseInt(newValue) || 0;
          const diff = newVal - oldVal;
          if (diff === 0) return;

          let logDate = new Date().toISOString().slice(0, 10);
          if (!logDate.startsWith(currentMonth)) logDate = currentMonth + "-01";
          const timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          member.history.push({ actionIdx: actionIndex, date: logDate, time: timeString, count: diff, note: "-" });
          saveMemberScore(member);
      };
      
      // ... Modal Logic (Cell, Member, History) attached to Window ...
      window.openCellModal = function(mIdx, aIdx) { if(isRangeMode) return; activeMemberId = teamData[mIdx].id; activeActionIndex = aIdx; document.getElementById('cellModalTitle').innerText = teamData[mIdx].name; const k = ['act_lead','act_medium','act_idea','act_simple','act_late','act_active','act_present','act_absent_excused','act_absent_no'][aIdx]; document.getElementById('cellModalSubtitle').innerText = (i18n[currentLang][k]||actionNames[aIdx]) + ` (${pointsMap[aIdx]} pts)`; let d = new Date().toISOString().slice(0,10); if(!d.startsWith(currentMonth)) d=currentMonth+"-01"; document.getElementById('cellNewDate').value=d; document.getElementById('cellNewCount').value=1; renderCellHistory(teamData[mIdx], aIdx); document.getElementById('cellModal').classList.remove('hidden'); document.getElementById('cellModal').classList.add('flex'); };
      window.closeCellModal = function() { document.getElementById('cellModal').classList.add('hidden'); document.getElementById('cellModal').classList.remove('flex'); activeMemberId=null; };
      
      function renderCellHistory(member, aIdx) {
          const tbody = document.getElementById('cellHistoryBody'); tbody.innerHTML = '';
          const logs = member.history.filter(l => l.actionIdx === aIdx);
          if(logs.length===0) { document.getElementById('noHistoryMsg').classList.remove('hidden'); } else { document.getElementById('noHistoryMsg').classList.add('hidden');
          logs.forEach(log => {
              const rIdx = member.history.indexOf(log);
              const tr = document.createElement('tr'); tr.className = "border-b border-slate-800 last:border-0";
              tr.innerHTML = `<td class="py-2 pl-2 text-slate-300">${log.date}</td><td class="py-2 pl-2 text-slate-400 text-xs">${log.time||'-'}</td><td class="py-2 text-white font-bold">${log.count>0?'+'+log.count:log.count}</td>
              <td class="py-2">
                 <div class="flex items-center gap-2">
                    <div class="truncate max-w-[100px] text-sm text-slate-400" id="note-${member.id}-${rIdx}">${log.note||'-'}</div>
                    ${log.note ? `<button onclick="toggleVisibility('note-${member.id}-${rIdx}')" class="text-xs text-indigo-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button>` : ''}
                 </div>
              </td>
              <td class="py-2 text-right"><button onclick="deleteLogEntry('${member.id}', ${rIdx})" class="text-red-400 hover:text-white px-2">&times;</button></td>`;
              tbody.appendChild(tr);
          }); }
      }
      
      window.addCellEntry = function() {
          const d = document.getElementById('cellNewDate').value; const c = parseInt(document.getElementById('cellNewCount').value);
          const note = document.getElementById('cellNewNote').value || "";
          if(!d || isNaN(c) || c===0) return alert("Invalid");
          const m = teamData.find(x => x.id === activeMemberId);
          if(m) {
              const t = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
              m.history.push({ actionIdx: activeActionIndex, date: d, time: t, count: c, note: note });
              
              saveMemberScore(m); renderCellHistory(m, activeActionIndex); 
          }
          document.getElementById('cellNewNote').value = ""; // Clear note input
      };
      
      window.deleteLogEntry = function(mId, lIdx) {
          const m = teamData.find(x => x.id === mId);
          if(m) { m.history.splice(lIdx, 1); saveMemberScore(m); renderCellHistory(m, activeActionIndex); }
      };

      // ... Member Management ...
      window.openMemberModal = function() { window.cancelEdit(); window.renderMemberList(); document.getElementById('memberModal').classList.remove('hidden'); document.getElementById('memberModal').classList.add('flex'); };
      window.closeMemberModal = function() { document.getElementById('memberModal').classList.add('hidden'); document.getElementById('memberModal').classList.remove('flex'); };
      window.renderMemberList = function() {
          const tbody = document.getElementById('memberListBody'); tbody.innerHTML = '';
          membersDB.forEach(m => {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td class="px-3 py-3 text-white font-medium">${m.name}</td><td class="px-3 py-3 text-slate-400 hidden sm:table-cell">${m.position||'-'}</td><td class="px-3 py-3 text-slate-400 hidden sm:table-cell">${m.uniId||'-'}</td><td class="px-3 py-3 text-right flex gap-2 justify-end"><button onclick="editMember('${m.id}')" class="text-indigo-400 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button><button onclick="deleteMember('${m.id}')" class="text-red-400 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td>`;
              tbody.appendChild(tr);
          });
      };
      
      window.saveMember = function() {
          const id = document.getElementById('editMemberId').value;
          const name = document.getElementById('newMemberName').value.trim();
          if(!name) return alert("Name required");
          if(id) { 
              const idx = membersDB.findIndex(x=>x.id===id); 
              if(idx>-1) membersDB[idx] = {
                  ...membersDB[idx], 
                  name: name, 
                  uniId: document.getElementById('newUniId').value, 
                  ieeeId: document.getElementById('newIeeeId').value,
                  major: document.getElementById('newMajor').value,
                  position: document.getElementById('newPosition').value
              }; 
          }
          else { 
              membersDB.push({ 
                  id: Date.now().toString(), 
                  name: name, 
                  uniId: document.getElementById('newUniId').value, 
                  ieeeId: document.getElementById('newIeeeId').value,
                  major: document.getElementById('newMajor').value,
                  position: document.getElementById('newPosition').value 
              }); 
          }
          saveRoster().then(() => { loadData(); window.renderMemberList(); window.cancelEdit(); });
      };
      
      window.deleteMember = function(id) {
          if(!confirm("Remove member?")) return;
          membersDB = membersDB.filter(x => x.id !== id);
          saveRoster().then(() => { loadData(); window.renderMemberList(); });
      };
      
      window.editMember = function(id) {
          const m = membersDB.find(x => x.id === id); if(!m) return;
          document.getElementById('editMemberId').value = m.id; 
          document.getElementById('newMemberName').value = m.name; 
          document.getElementById('newUniId').value = m.uniId||''; 
          document.getElementById('newIeeeId').value = m.ieeeId||''; 
          document.getElementById('newMajor').value = m.major||''; 
          document.getElementById('newPosition').value = m.position||'';
          document.getElementById('saveMemberBtn').innerText = "Save"; document.getElementById('cancelEditBtn').classList.remove('hidden');
      };
      
      window.cancelEdit = function() {
          document.getElementById('editMemberId').value = ""; 
          document.getElementById('newMemberName').value = ""; 
          document.getElementById('newUniId').value = ""; 
          document.getElementById('newIeeeId').value = ""; 
          document.getElementById('newMajor').value = ""; 
          document.getElementById('newPosition').value = "";
          document.getElementById('saveMemberBtn').innerText = "Add"; document.getElementById('cancelEditBtn').classList.add('hidden');
      };

      // --- Reports ---
      window.openExportModal = function() { document.getElementById('exportStart').value=currentMonth; document.getElementById('exportEnd').value=currentMonth; document.getElementById('exportModal').classList.remove('hidden'); document.getElementById('exportModal').classList.add('flex'); };
      window.closeExportModal = function() { document.getElementById('exportModal').classList.add('hidden'); document.getElementById('exportModal').classList.remove('flex'); };
      
      // --- Rendering Helpers ---
      function renderTable() {
         const tbody = document.getElementById('trackerBody'); tbody.innerHTML = '';
         teamData.forEach((m, idx) => {
             const tr = document.createElement('tr'); tr.className = 'group transition-colors';
             const nTd = document.createElement('td'); nTd.className = 'sticky-col p-3 border-r border-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)]'; nTd.innerHTML = `<div class="flex flex-col justify-center h-full"><div class="text-slate-200 font-bold text-sm truncate">${m.name}</div><div class="text-slate-500 text-xs truncate">${m.position||''}</div></div>`; tr.appendChild(nTd);
             const tTd = document.createElement('td'); tTd.className = 'sticky-col-2 p-3 text-center font-bold text-lg border-r border-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)]'; tTd.id = `total-${idx}`; tTd.innerText = '0'; tr.appendChild(tTd);
             pointsMap.forEach((pts, aIdx) => {
                 const td = document.createElement('td'); td.className = 'p-1 border-r border-slate-800/50 last:border-0 text-center relative';
                 const inp = document.createElement('input'); inp.type = 'number'; inp.value = m.actions[aIdx]===0?'':m.actions[aIdx]; inp.placeholder = isRangeMode ? '' : '-';
                 let base = "w-full h-full bg-transparent text-center font-medium focus:outline-none focus:bg-indigo-900/30 transition-colors p-3 cursor-pointer";
                 let col = (m.actions[aIdx]!==0) ? "text-white font-bold" : "text-slate-500 focus:text-white focus:font-bold";
                 if(isRangeMode) { inp.readOnly = true; base += ' read-only-input'; } else { inp.ondblclick = () => openCellModal(idx, aIdx); }
                 inp.className = `${base} ${col}`;
                 if(!isRangeMode) { inp.onchange = (e) => updateAction(idx, aIdx, e.target.value); }
                 td.appendChild(inp); tr.appendChild(td);
             });
             tbody.appendChild(tr);
         });
      }

      function updateCalculations() {
          const ranked = teamData.map(m => ({ name: m.name, score: m.actions.reduce((a,c,i)=>a+(c*pointsMap[i]),0) })).sort((a,b)=>b.score-a.score);
          if(ranked[0]) { document.getElementById('top1Name').innerText = ranked[0].score>0?ranked[0].name:"---"; document.getElementById('top1Score').innerText = ranked[0].score+" pts"; }
          if(ranked[1]) { document.getElementById('top2Name').innerText = ranked[1].score>0?ranked[1].name:"---"; document.getElementById('top2Score').innerText = ranked[1].score+" pts"; }
          if(ranked[2]) { document.getElementById('top3Name').innerText = ranked[2].score>0?ranked[2].name:"---"; document.getElementById('top3Score').innerText = ranked[2].score+" pts"; }
          teamData.forEach((m, idx) => {
              const tot = m.actions.reduce((a,c,i)=>a+(c*pointsMap[i]),0);
              const el = document.getElementById(`total-${idx}`);
              if(el) { el.innerText = tot; el.className = `sticky-col-2 p-3 text-center font-bold text-lg border-r border-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] ${tot>0?'text-emerald-400':(tot<0?'text-red-400':'text-slate-500')}`; }
          });
      }

      function initChart() {
          if(myChart) myChart.destroy();
          const ctx = document.getElementById('scoreChart').getContext('2d');
          Chart.defaults.color = '#94a3b8'; Chart.defaults.font.family = "'Inter', sans-serif"; Chart.register(ChartDataLabels);
          myChart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ label: 'Points', data: [], backgroundColor: '#6366f1', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { grid: { color: '#334155' }, beginAtZero: true }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, datalabels: { color: '#fff', anchor: 'end', align: 'end', font: { weight: 'bold' } } }, layout: { padding: { right: 30 } } } });
      }

      function updateChart() {
          if (!myChart) return;
          const sorted = [...teamData].map(m => ({ name: m.name, score: m.actions.reduce((a,c,i)=>a+(c*pointsMap[i]),0) })).sort((a,b)=>b.score-a.score);
          document.getElementById('chartWrapper').style.height = `${Math.max(250, sorted.length * 35)}px`;
          myChart.data.labels = sorted.map(d => d.name); myChart.data.datasets[0].data = sorted.map(d => d.score);
          myChart.resize(); myChart.update();
      }
      
      window.exportCSV = function() {
          if(isRangeMode) return performRangeExport();
          const titles = ["Lead Event", "Medium Task", "New Idea", "Simple Task", "Late Submission", "Present Active", "Present", "Absent Excused", "Absent No Excuse"];
          let csv = "data:text/csv;charset=utf-8,";
          csv += `Report: ${currentMonth}\nName,Uni ID,Position,Total Score,${titles.join(",")}\n`;
          teamData.forEach(m => {
              const tot = m.actions.reduce((a,c,i)=>a+(c*pointsMap[i]),0);
              csv += `${m.name},${m.uniId||''},${m.position||''},${tot},${m.actions.join(",")}\n`;
          });
          const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", `team_tracker_${currentMonth}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
      };

      // Add other modal openers like openHistoryModal, etc. if needed for buttons
      window.openHistoryModal = function() {
          const tbody = document.getElementById('fullHistoryBody'); tbody.innerHTML = '';
          let allLogs = [];
          teamData.forEach(m => { m.history.forEach((l,i) => { allLogs.push({...l, mId: m.id, oIdx: i, mName: m.name, pts: l.count*pointsMap[l.actionIdx] }); }); });
          allLogs.sort((a,b) => new Date(b.date+' '+(b.time||'00:00')) - new Date(a.date+' '+(a.time||'00:00')));
          allLogs.forEach(l => {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td class="px-4 py-2">${l.date}</td><td class="px-4 py-2 text-slate-400 text-xs">${l.time||'-'}</td><td class="px-4 py-2 text-white">${l.mName}</td><td class="px-4 py-2">${actionNames[l.actionIdx]} (${l.count})</td>
              <td class="px-4 py-2">
                 <div class="flex items-center gap-2">
                    <div class="truncate max-w-[150px] text-sm text-slate-400" id="hist-note-${l.mId}-${l.oIdx}">${l.note||'-'}</div>
                    ${l.note ? `<button onclick="toggleVisibility('hist-note-${l.mId}-${l.oIdx}')" class="text-xs text-indigo-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button>` : ''}
                 </div>
              </td>
              <td class="px-4 py-2 text-right ${l.pts>=0?'text-emerald-400':'text-red-400'}">${l.pts}</td><td class="px-4 py-2 text-right"><button onclick="deleteGlobalLogEntry('${l.mId}', ${l.oIdx})" class="text-slate-500 hover:text-red-400">&times;</button></td>`;
              tbody.appendChild(tr);
          });
          document.getElementById('historyModal').classList.remove('hidden'); document.getElementById('historyModal').classList.add('flex');
      };
      
      window.toggleVisibility = function(elementId) {
          const el = document.getElementById(elementId);
          if(el) {
              el.classList.toggle('truncate');
              el.classList.toggle('max-w-[150px]'); // for history modal
              el.classList.toggle('max-w-[100px]'); // for cell modal
              el.classList.toggle('whitespace-normal');
              el.classList.toggle('break-all');
          }
      };
      
      window.closeHistoryModal = function() { document.getElementById('historyModal').classList.add('hidden'); document.getElementById('historyModal').classList.remove('flex'); };
      
      window.deleteGlobalLogEntry = function(mId, lIdx) {
           if(!confirm("Delete?")) return;
           const m = teamData.find(x => x.id === mId);
           if(m) { m.history.splice(lIdx, 1); saveMemberScore(m); window.openHistoryModal(); }
      };

      // Range Logic (View Only)
      window.performRangeView = function() {
          const start = document.getElementById('exportStart').value;
          const end = document.getElementById('exportEnd').value;
          if(!start || !end || start > end) return alert("Invalid range");
          
          let currentIter = new Date(start + "-01");
          const endDate = new Date(end + "-01");
          const aggregatedMap = {};
          
          // Seed with roster
          membersDB.forEach(m => { aggregatedMap[m.id] = { ...m, actions: Array(pointsMap.length).fill(0), history: [] }; });
          
          // Fetch logic for range
          // Construct list of months
          const months = [];
          while(currentIter <= endDate) {
              const yyyy = currentIter.getFullYear();
              const mm = String(currentIter.getMonth() + 1).padStart(2, '0');
              months.push(`${yyyy}-${mm}`);
              currentIter.setMonth(currentIter.getMonth() + 1);
          }
          
          // Get all scores
          getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores')).then(snapshot => {
              snapshot.forEach(doc => {
                  const [mth, mid] = doc.id.split('_');
                  if(months.includes(mth) && aggregatedMap[mid]) {
                      const data = doc.data();
                      if(data.history) {
                           data.history.forEach(log => {
                               if(aggregatedMap[mid].actions[log.actionIdx]!==undefined)
                                  aggregatedMap[mid].actions[log.actionIdx] += log.count;
                           });
                      }
                  }
              });
              
              teamData = Object.values(aggregatedMap);
              isRangeMode = true;
              document.getElementById('pageSubtitle').innerText = `Aggregated View: ${start} to ${end}`;
              document.getElementById('pageSubtitle').classList.add('text-emerald-400', 'font-bold');
              document.getElementById('standardControls').classList.add('hidden');
              document.getElementById('exitRangeBtn').classList.remove('hidden');
              renderTable(); updateCalculations(); updateChart(); window.closeExportModal();
          });
      };
      
      window.performRangeExport = function() {
          const start = document.getElementById('exportStart').value;
          const end = document.getElementById('exportEnd').value;
          if(!start || !end || start > end) return alert("Invalid range");
          
          // Same logic as view but generate CSV directly
          let currentIter = new Date(start + "-01");
          const endDate = new Date(end + "-01");
          const months = [];
          while(currentIter <= endDate) {
              const yyyy = currentIter.getFullYear();
              const mm = String(currentIter.getMonth() + 1).padStart(2, '0');
              months.push(`${yyyy}-${mm}`);
              currentIter.setMonth(currentIter.getMonth() + 1);
          }
          
          const aggregatedMap = {};
          membersDB.forEach(m => { aggregatedMap[m.id] = { ...m, actions: Array(pointsMap.length).fill(0) }; });

           getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores')).then(snapshot => {
              snapshot.forEach(doc => {
                  const [mth, mid] = doc.id.split('_');
                  if(months.includes(mth) && aggregatedMap[mid]) {
                      const data = doc.data();
                      if(data.history) {
                           data.history.forEach(log => {
                               if(aggregatedMap[mid].actions[log.actionIdx]!==undefined)
                                  aggregatedMap[mid].actions[log.actionIdx] += log.count;
                           });
                      }
                  }
              });
              
              const titles = ["Lead Event", "Medium Task", "New Idea", "Simple Task", "Late Submission", "Present Active", "Present", "Absent Excused", "Absent No Excuse"];
              let csv = "data:text/csv;charset=utf-8,";
              csv += `Aggregated Report: ${start} to ${end}\nName,Uni ID,Position,Total Score,${titles.join(",")}\n`;
              Object.values(aggregatedMap).forEach(m => {
                  const tot = m.actions.reduce((a,c,i)=>a+(c*pointsMap[i]),0);
                  csv += `${m.name},${m.uniId||''},${m.position||''},${tot},${m.actions.join(",")}\n`;
              });
              const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", `team_report_${start}_to_${end}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
              window.closeExportModal();
          });
      };
      
      window.exitRangeMode = function() {
          isRangeMode = false;
          document.getElementById('pageSubtitle').innerText = "Monthly scorecard & leaderboard";
          document.getElementById('pageSubtitle').classList.remove('text-emerald-400', 'font-bold');
          document.getElementById('standardControls').classList.remove('hidden');
          document.getElementById('exitRangeBtn').classList.add('hidden');
          loadData(); // Re-trigger live reload
      };
      
      window.resetData = function() {
            if(isRangeMode) return;
            if(confirm(`Reset scores for ${currentMonth}? Names will be kept.`)) {
                teamData.forEach(member => {
                    member.history = []; // Clear history
                    saveMemberScore(member); // Save empty history
                });
                // Table will auto-update via listener
            }
      };

    </script>
</body>
</html>
